# Twilio Content Template Builder API Integration

This document explains how to use the **Twilio Content Template Builder API** for managing WhatsApp message templates programmatically in the Fini AI application.

Based on: https://www.twilio.com/docs/content

## Overview

The Content Template Builder API allows you to:
- âœ… Create message templates programmatically 
- âœ… Submit templates for WhatsApp approval automatically
- âœ… Manage template lifecycle (create, update, delete)
- âœ… Generate environment variables dynamically
- âœ… Maintain consistent template versioning

## Quick Start

### 1. Set Up Credentials

Ensure your `.env.local` has Twilio credentials:

```bash
# Twilio Configuration
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your-auth-token
TWILIO_PHONE_NUMBER=+1234567890
```

### 2. Create All Fini Templates

Use the management script to create all predefined templates:

```bash
# List existing templates
node scripts/manage-content-templates.js list

# Create all Fini AI templates at once
node scripts/manage-content-templates.js create-all

# Generate environment variables for .env.local
node scripts/manage-content-templates.js env-vars
```

### 3. Update Environment Variables

After creation, add the generated Content SIDs to your `.env.local`:

```bash
# WhatsApp Content Template SIDs (Generated by Content Template Builder API)
TWILIO_OTP_CONTENTSID=HXxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_WELCOME_CONTENTSID=HXxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_ANALYTICS_CONTENTSID=HXxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_MARKETING_CONTENTSID=HXxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_ERROR_CONTENTSID=HXxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_DAILY_SUMMARY_CONTENTSID=HXxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## Template Configurations

### Available Templates

The system includes these predefined templates:

#### 1. OTP Verification Template
- **Name**: `fini_otp_verification_v3`
- **Category**: `AUTHENTICATION`
- **Variables**: `{{1}}` = OTP Code, `{{2}}` = Expiry minutes
- **Use Case**: User phone verification

#### 2. Welcome Message Template
- **Name**: `fini_welcome_v3`
- **Category**: `MARKETING`
- **Variables**: `{{1}}` = User name, `{{2}}` = Store name
- **Use Case**: Post-verification welcome

#### 3. Analytics Report Template
- **Name**: `fini_analytics_v3`
- **Category**: `UTILITY`
- **Variables**: `{{1}}` = Sales, `{{2}}` = Orders, `{{3}}` = Store name
- **Use Case**: Daily/weekly analytics reports

#### 4. Marketing Ideas Template
- **Name**: `fini_marketing_v3`
- **Category**: `MARKETING`
- **Variables**: `{{1}}` = Store name, `{{2}}` = Idea 1, `{{3}}` = Idea 2
- **Use Case**: AI-generated marketing suggestions

#### 5. Error Support Template
- **Name**: `fini_error_v3`
- **Category**: `UTILITY`
- **Variables**: `{{1}}` = User name, `{{2}}` = Error type
- **Use Case**: Error handling and support

#### 6. Daily Summary Template
- **Name**: `fini_daily_summary_v3`
- **Category**: `UTILITY`
- **Variables**: `{{1}}` = Store name, `{{2}}` = Sales, `{{3}}` = Orders, `{{4}}` = Top product
- **Use Case**: Automated daily business summaries

## API Usage

### Using the API Routes

#### List All Templates
```bash
curl -X GET http://localhost:3000/api/whatsapp/content-builder
```

#### Create a Template
```bash
curl -X POST http://localhost:3000/api/whatsapp/content-builder \
  -H "Content-Type: application/json" \
  -d '{
    "templateType": "WELCOME_MESSAGE",
    "friendlyName": "fini_welcome_v3",
    "content": "Â¡Hola {{1}}! ðŸ‘‹\n\nðŸŽ‰ Â¡Bienvenido a Fini AI para {{2}}!",
    "variables": {
      "1": "Nombre del usuario",
      "2": "Nombre de la tienda"
    }
  }'
```

#### Delete a Template
```bash
curl -X DELETE "http://localhost:3000/api/whatsapp/content-builder?sid=HXxxxxx"
```

### Using the Management Script

The management script provides a CLI interface:

```bash
# Available commands
node scripts/manage-content-templates.js list        # List all templates
node scripts/manage-content-templates.js create-all # Create all Fini templates
node scripts/manage-content-templates.js env-vars   # Generate environment variables
```

## WhatsApp Template Approval Process

### Approval Categories

- **AUTHENTICATION**: OTP and verification messages
- **MARKETING**: Promotional and welcome messages  
- **UTILITY**: Analytics, summaries, and support messages

### Approval Timeline

- **Automatic approval**: Some utility templates
- **Manual review**: Marketing templates (24-48 hours)
- **Complex approval**: Custom promotional content

### Checking Approval Status

1. Visit [Twilio Console - Content Template Builder](https://console.twilio.com/us1/develop/sms/content-template-builder)
2. Check template status: `APPROVED`, `PENDING`, `REJECTED`, or `DRAFT`
3. Monitor approval requests in the console

## Integration with Existing WhatsApp Service

The templates are automatically integrated with the existing `TwilioWhatsAppService`:

```typescript
// Templates are now managed via Content Template Builder API
import { WHATSAPP_TEMPLATES } from '@/lib/integrations/twilio-whatsapp';

// Send a template message
await twilioService.sendTemplateByType(phoneNumber, 'welcome', {
  displayName: 'Usuario',
  storeName: 'Mi Tienda'
});
```

### Smart Template Fallback

The system maintains smart fallback logic:

1. **Try freeform message** (works within 24h window)
2. **Detect error 63016** (outside 24h window)
3. **Automatically select appropriate template**
4. **Send using contentSid + contentVariables**

## Template Versioning

### Version Strategy

- Templates use `v3` suffix for latest Content Template Builder API version
- Previous versions (`v1`, `v2`) maintain backward compatibility
- Environment variables automatically point to latest versions

### Updating Templates

To update template content:

1. Create new version: `fini_template_name_v4`
2. Submit for approval
3. Update environment variables after approval
4. Deploy with new Content SIDs

## Best Practices

### Template Design

1. **Keep it concise**: WhatsApp has character limits
2. **Use emojis sparingly**: Enhance readability without overuse
3. **Clear variable names**: Use descriptive placeholders
4. **Test thoroughly**: Verify all variable combinations

### Variable Management

1. **Consistent naming**: Use numbered variables (`{{1}}`, `{{2}}`, etc.)
2. **Document variables**: Comment expected values and formats
3. **Validate inputs**: Ensure variables match template expectations
4. **Handle empty values**: Provide defaults for optional variables

### Security Considerations

1. **Environment variables**: Never expose Content SIDs in client-side code
2. **API access**: Protect template management APIs with authentication
3. **Rate limiting**: Implement rate limits for template creation
4. **Audit logs**: Monitor template usage and modifications

## Troubleshooting

### Common Issues

#### 1. Template Creation Fails
```
Error: Property 'create' does not exist on type 'ContentListInstance'
```
**Solution**: Update Twilio SDK version or use the management script instead of TypeScript API.

#### 2. Approval Request Fails
```
Error: Template not found for approval
```
**Solution**: Ensure template exists before submitting for approval. Check Content SID.

#### 3. Variable Mismatch
```
Error: Template variables do not match provided variables
```
**Solution**: Verify variable count and naming convention (`{{1}}`, `{{2}}`, etc.).

### Debugging Commands

```bash
# Check template status
node scripts/manage-content-templates.js list

# Verify credentials
node scripts/check-env.js

# Test template creation manually
curl -X GET http://localhost:3000/api/whatsapp/content-builder
```

### Logs to Monitor

- `[CONTENT_API]` - Template creation and management
- `[CONTENT_BUILDER]` - API route operations
- `[WHATSAPP]` - Message sending with templates
- `[ERROR]` - Failed operations and errors

## Migration from Manual Templates

If migrating from manually created templates:

1. **Export existing Content SIDs** from Twilio Console
2. **Update environment variables** to match new template names
3. **Test template sending** with existing WhatsApp service
4. **Gradually migrate** to Content Template Builder API management

## Support and Resources

- **Twilio Docs**: https://www.twilio.com/docs/content
- **Console**: https://console.twilio.com/us1/develop/sms/content-template-builder
- **API Reference**: https://www.twilio.com/docs/content/api
- **Fini AI Integration**: Check `src/lib/integrations/twilio-content-templates.ts`

---

## Quick Reference

### Environment Variables
```bash
TWILIO_ACCOUNT_SID=          # Your Twilio Account SID
TWILIO_AUTH_TOKEN=           # Your Twilio Auth Token
TWILIO_PHONE_NUMBER=         # WhatsApp Business number
TWILIO_OTP_CONTENTSID=       # OTP template Content SID
TWILIO_WELCOME_CONTENTSID=   # Welcome template Content SID
TWILIO_ANALYTICS_CONTENTSID= # Analytics template Content SID
TWILIO_MARKETING_CONTENTSID= # Marketing template Content SID
TWILIO_ERROR_CONTENTSID=     # Error template Content SID
TWILIO_DAILY_SUMMARY_CONTENTSID= # Daily summary template Content SID
```

### Key Files
- `src/lib/integrations/twilio-content-templates.ts` - Template service
- `src/app/api/whatsapp/content-builder/route.ts` - API routes
- `scripts/manage-content-templates.js` - Management CLI
- `src/lib/integrations/twilio-whatsapp.ts` - WhatsApp integration

### CLI Commands
```bash
node scripts/manage-content-templates.js list        # List templates
node scripts/manage-content-templates.js create-all  # Create all templates
node scripts/manage-content-templates.js env-vars    # Generate env vars
``` 