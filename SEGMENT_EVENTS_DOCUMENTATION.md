# üìä DOCUMENTACI√ìN COMPLETA DE EVENTOS SEGMENT - FINI AI

## üéØ Resumen Ejecutivo

Implementaci√≥n completa de Segment CDP para tracking exhaustivo de eventos de usuario y analytics avanzado. El sistema permite enviar datos a m√∫ltiples plataformas de marketing para upselling, cross-selling y optimizaci√≥n de conversi√≥n.

### üìà Beneficios Implementados

- **CDP Centralizado**: Todos los eventos van a Segment y se distribuyen autom√°ticamente
- **Marketing Attribution**: Tracking completo del customer journey 
- **Upselling Intelligence**: Detecta cuando usuarios llegan a l√≠mites del plan
- **Retention Analytics**: Tracking de engagement y abandono
- **Performance Monitoring**: M√©tricas de velocidad y errores

---

## üèóÔ∏è ARQUITECTURA DE TRACKING

### Server-Side Tracking
```typescript
// Ubicaci√≥n: src/lib/analytics/segment-server.ts
// Usado en: APIs, webhooks, procesos de backend
// Beneficio: Datos confiables, no bloqueables por ad-blockers
```

### Client-Side Tracking  
```typescript
// Ubicaci√≥n: src/lib/analytics/segment-client.ts
// Usado en: Componentes React, interacciones UI
// Beneficio: Eventos en tiempo real, context del navegador
```

### Automatic Provider
```typescript
// Ubicaci√≥n: src/components/analytics-provider.tsx
// Integrado en: src/components/providers.tsx
// Beneficio: Page views autom√°ticos, error tracking global
```

---

## üìã **LISTADO DETALLADO DE EVENTOS POR PANTALLA/ACCI√ìN**

### üè† **P√ÅGINA PRINCIPAL (`/`)**

#### Page Views
- **Event**: `Page Viewed`
- **Properties**: `page`, `url`, `referrer`, `section: 'home'`, `userAgent`, `loadTime`
- **Trigger**: Autom√°tico al cargar la p√°gina
- **Implementation**: AnalyticsProvider (client-side)

#### CTA Interactions
- **Event**: `Button Clicked`
- **Properties**: `buttonName`, `page: '/'`, `userId` (si logueado)
- **Trigger**: Click en CTAs principales
- **Uso Marketing**: Optimizaci√≥n de conversion funnel

### üîê **AUTENTICACI√ìN (`/auth/signin`, `/auth/signup`)**

#### Page Views
- **Event**: `Page Viewed`  
- **Properties**: `page`, `url`, `section: 'auth'`, `referrer`
- **Trigger**: Autom√°tico al cargar p√°ginas auth
- **Implementation**: AnalyticsProvider

#### Sign Up Flow
- **Event**: `Sign Up Started`
- **Properties**: `source`, `referrer`, `method: 'email'`
- **Trigger**: Client-side al iniciar proceso
- **Implementation**: useAnalytics hook

- **Event**: `User Signed Up`
- **Properties**: `email`, `method`, `source`, `referrer`
- **Trigger**: Server-side en API callback de auth
- **Implementation**: segmentServerAnalytics
- **Uso Marketing**: Nurturing sequences para nuevos usuarios

#### Sign In Flow
- **Event**: `Sign In Started`
- **Properties**: `method: 'email'`
- **Trigger**: Client-side al iniciar sesi√≥n

- **Event**: `User Signed In`
- **Properties**: `method`, `source`, `sessionDuration`
- **Trigger**: Server-side al completar auth
- **Uso Marketing**: Re-engagement campaigns

### üéØ **ONBOARDING (`/onboarding`)**

#### Onboarding Steps
- **Event**: `Onboarding Step Viewed`
- **Properties**: `step`, `stepName`, `userId`, `hasStores`, `onboardingCompleted`
- **Trigger**: useAnalytics al cambiar de step
- **Implementation**: src/app/onboarding/page.tsx l√≠nea 147

- **Event**: `Onboarding Step Completed`
- **Properties**: `step`, `stepName`, `nextStep`, `hasStores`, `onboardingCompleted`
- **Trigger**: handleNextStep() en onboarding
- **Uso Marketing**: Identificar puntos de abandono

#### Store Connection
- **Event**: `Feature Used`
- **Properties**: `featureName: 'store-connection'`, `method: 'oauth'`, `storeUrl`, `storeName`, `step`
- **Trigger**: handleStoreConnection() antes de OAuth
- **Implementation**: src/app/onboarding/page.tsx l√≠nea 224

- **Event**: `Store Connected`
- **Properties**: `storeId`, `storeName`, `platform: 'tiendanube'`, `domain`
- **Trigger**: Server-side en OAuth callback exitoso
- **Implementation**: src/app/api/user/complete-onboarding/route.ts
- **Uso Marketing**: Activaci√≥n exitosa, upselling a plan Pro

#### Onboarding Completion
- **Event**: `Onboarding Completed`
- **Properties**: `totalSteps: 6`, `timeSpent`, `planSelected: 'free'`, `storeConnected`, `whatsappConnected`
- **Trigger**: Server-side al completar onboarding
- **Implementation**: src/app/api/user/complete-onboarding/route.ts l√≠nea 49
- **Uso Marketing**: Welcome series, feature education

#### Error Tracking
- **Event**: `Client Error`
- **Properties**: `feature: 'store-connection'`, `step`, `storeUrl`, `storeName`, `errorMessage`
- **Trigger**: catch blocks en onboarding
- **Uso Marketing**: Soporte proactivo, mejora UX

### üí¨ **CHAT DASHBOARD (`/dashboard`)**

#### Page Views
- **Event**: `Page Viewed`
- **Properties**: `page: 'Dashboard'`, `section: 'dashboard'`, `userId`
- **Trigger**: Autom√°tico al cargar dashboard
- **Implementation**: AnalyticsProvider

#### Chat Interactions
- **Event**: `Conversation Started`
- **Properties**: `conversationId`, `storeId`, `source: 'dashboard'`
- **Trigger**: Server-side al crear nueva conversaci√≥n
- **Implementation**: src/app/api/chat/send/route.ts l√≠nea 79
- **Uso Marketing**: Engagement scoring, feature usage

- **Event**: `Chat Message Sent`
- **Properties**: `conversationId`, `storeId`, `messageType: 'user'`, `messageLength`, `query`, `success: true`
- **Trigger**: Server-side despu√©s de guardar mensaje
- **Implementation**: src/app/api/chat/send/route.ts l√≠nea 160

- **Event**: `AI Agent Used`
- **Properties**: `agentType`, `query`, `responseTime`, `confidence`, `success`, `conversationId`
- **Trigger**: Server-side despu√©s de respuesta de agente
- **Implementation**: src/app/api/chat/send/route.ts l√≠nea 167
- **Uso Marketing**: Feature value demonstration, upgrade prompts

#### Dashboard Navigation
- **Event**: `Dashboard Tab Clicked`
- **Properties**: `tabName`, `section: 'dashboard'`
- **Trigger**: Client-side al cambiar tabs
- **Implementation**: useAnalytics.trackButtonClick

### üè™ **TIENDA NUBE INTEGRATION**

#### Store Analysis
- **Event**: `Store Analyzed`
- **Properties**: `storeId`, `analysisType: 'ai'`, `productCount`, `categories`, `timeSpent`, `success`
- **Trigger**: Server-side despu√©s de an√°lisis con AI
- **Implementation**: Autom√°tico en an√°lisis de tienda

#### Store Sync
- **Event**: `Store Sync Completed`
- **Properties**: `storeId`, `dataTypes: ['products', 'orders']`, `recordsProcessed`, `timeSpent`
- **Trigger**: Server-side al completar sincronizaci√≥n
- **Uso Marketing**: Health monitoring, re-engagement si sync falla

### üì± **WHATSAPP INTEGRATION**

#### WhatsApp Setup
- **Event**: `WhatsApp Setup Started`
- **Properties**: `page: '/onboarding'`
- **Trigger**: Client-side al iniciar configuraci√≥n
- **Implementation**: useAnalytics hook

- **Event**: `WhatsApp OTP Requested`
- **Properties**: `phoneNumber` (masked)
- **Trigger**: Client-side al solicitar OTP
- **Implementation**: segmentClientAnalytics.trackOTPRequested

- **Event**: `WhatsApp Connected`
- **Properties**: `phoneNumber`, `verificationMethod: 'otp'`, `timeSpent`, `attempts`
- **Trigger**: Server-side al verificar exitosamente
- **Uso Marketing**: Feature activation, success onboarding

### üí≥ **SUBSCRIPTION MANAGEMENT**

#### Plan Limits
- **Event**: `Plan Limit Reached`
- **Properties**: `feature`, `currentPlan: 'free'`, `limitType`, `upgradePrompted: true`
- **Trigger**: Server-side cuando se alcanza l√≠mite
- **Uso Marketing**: **CR√çTICO** para upselling autom√°tico

#### Upgrade Flow
- **Event**: `Upgrade Prompt Shown`
- **Properties**: `trigger: 'limit_reached'`, `currentPlan`, `page`
- **Trigger**: Client-side al mostrar prompt
- **Implementation**: useAnalytics.trackUpgradePromptShown

- **Event**: `Upgrade Prompt Clicked`
- **Properties**: `currentPlan`, `targetPlan`, `page`
- **Trigger**: Client-side al hacer click
- **Uso Marketing**: Conversion tracking de upsells

- **Event**: `Subscription Upgraded`
- **Properties**: `previousPlan`, `newPlan`, `amount`, `currency`, `trigger`
- **Trigger**: Server-side al completar upgrade
- **Uso Marketing**: Revenue attribution, churn prediction

### ‚ö° **FEATURE USAGE**

#### General Feature Tracking
- **Event**: `Feature Used`
- **Properties**: `featureName`, `success`, `page`, `planRequired`, `planLimit`
- **Trigger**: useAnalytics.trackFeature en componentes
- **Uso Marketing**: Feature adoption, upgrade prompts

#### Feature Discovery
- **Event**: `Feature Discovered`
- **Properties**: `featureName`, `page`
- **Trigger**: Client-side al ver feature primera vez
- **Uso Marketing**: Feature education sequences

### üîß **ERROR & PERFORMANCE TRACKING**

#### Client Errors
- **Event**: `Client Error`
- **Properties**: `errorMessage`, `errorStack`, `page`, `userAgent`, `url`
- **Trigger**: Autom√°tico via AnalyticsProvider error handlers
- **Implementation**: Global error boundary
- **Uso Marketing**: Support tickets proactivos

#### API Errors  
- **Event**: `API Error`
- **Properties**: `endpoint`, `method`, `statusCode`, `errorMessage`, `responseTime`
- **Trigger**: Server-side en catch blocks de APIs
- **Uso Marketing**: Service health monitoring

#### Performance Metrics
- **Event**: `Page Load Time`
- **Properties**: `loadTime`, `page`, `connection`
- **Trigger**: Client-side despu√©s de window.load
- **Implementation**: AnalyticsProvider
- **Uso Marketing**: UX optimization data

---

## üîß **CONFIGURACI√ìN T√âCNICA**

### Variables de Entorno Requeridas
```bash
# Server-side tracking
SEGMENT_WRITE_KEY=your_segment_server_key

# Client-side tracking  
NEXT_PUBLIC_SEGMENT_WRITE_KEY=your_segment_client_key
```

### Archivos de Implementaci√≥n
```
src/lib/analytics/
‚îú‚îÄ‚îÄ segment-server.ts       # Server-side tracking
‚îú‚îÄ‚îÄ segment-client.ts       # Client-side tracking
‚îú‚îÄ‚îÄ use-analytics.ts        # React hook
‚îú‚îÄ‚îÄ events.ts              # Event constants
‚îú‚îÄ‚îÄ types.ts               # TypeScript types
‚îî‚îÄ‚îÄ index.ts               # Main exports

src/components/
‚îú‚îÄ‚îÄ analytics-provider.tsx  # Auto-tracking provider
‚îî‚îÄ‚îÄ providers.tsx          # Integration point

APIs con tracking integrado:
‚îú‚îÄ‚îÄ src/app/api/chat/send/route.ts
‚îú‚îÄ‚îÄ src/app/api/user/complete-onboarding/route.ts
‚îî‚îÄ‚îÄ src/app/onboarding/page.tsx
```

### Uso en Componentes
```typescript
import { useAnalytics } from '@/lib/analytics/use-analytics';

export function MyComponent() {
  const { trackButtonClick, trackFeature, trackError } = useAnalytics();
  
  const handleClick = () => {
    trackButtonClick('upgrade-to-pro', { currentPlan: 'free' });
  };
  
  const handleFeatureUse = () => {
    trackFeature('advanced-analytics', true, { planRequired: 'pro' });
  };
}
```

---

## üìä **CASOS DE USO PARA MARKETING**

### 1. Upselling Inteligente
- **Trigger**: `Plan Limit Reached` + `Feature Used` con `planRequired: 'pro'`
- **Acci√≥n**: Email sequence explicando beneficios del plan Pro
- **Conversi√≥n**: Track `Upgrade Prompt Clicked` ‚Üí `Subscription Upgraded`

### 2. Onboarding Abandonment Recovery
- **Trigger**: `Onboarding Step Viewed` pero no `Onboarding Step Completed` en 24h
- **Acci√≥n**: Email con tips para completar el paso espec√≠fico
- **Personalizaci√≥n**: Diferente mensaje seg√∫n step (tienda, WhatsApp, etc)

### 3. Feature Adoption Campaigns
- **Trigger**: `User Signed Up` + no `Feature Used` en 7 d√≠as
- **Acci√≥n**: Tutorial personalizado de la feature m√°s popular
- **Segmentaci√≥n**: Por industry/store type usando store analysis data

### 4. Churn Prevention
- **Trigger**: Ausencia de `Chat Message Sent` en 14 d√≠as
- **Acci√≥n**: "Miss you" email con tips de valor
- **Incentivo**: Free month o descuento en upgrade

### 5. Success-Based Upselling
- **Trigger**: `AI Agent Used` con `confidence > 0.8` + `Chat Message Sent` > 50 veces
- **Acci√≥n**: "You're a power user!" email con upgrade offer
- **Timing**: Mejor conversi√≥n cuando users ven valor

### 6. Error Recovery & Support
- **Trigger**: `Client Error` o `API Error` para mismo usuario m√∫ltiples veces
- **Acci√≥n**: Support proactivo con soluci√≥n espec√≠fica
- **Follow-up**: `Feature Used` exitoso despu√©s de soporte

---

## üéØ **M√âTRICAS CLAVE A MONITOREAR**

### Conversion Funnel
```
Page Viewed (home) 
‚Üí Sign Up Started 
‚Üí User Signed Up 
‚Üí Onboarding Started 
‚Üí Store Connected 
‚Üí Onboarding Completed 
‚Üí Feature Used (first chat)
‚Üí Plan Limit Reached 
‚Üí Subscription Upgraded
```

### Engagement Scoring
```
High Value Events (10 points):
- Onboarding Completed
- Store Connected  
- AI Agent Used (confidence > 0.7)

Medium Value Events (5 points):
- Chat Message Sent
- Feature Used
- WhatsApp Connected

Low Value Events (1 point):
- Page Viewed
- Button Clicked
```

### Churn Predictors
```
Risk Indicators:
- No Chat Message Sent in 7 days
- Multiple Client Errors in session
- Onboarding abandoned at store connection
- Plan Limit Reached but no Upgrade Prompt Clicked
```

---

## ‚úÖ **CHECKLIST DE IMPLEMENTACI√ìN**

### ‚úÖ Completado
- [x] Segment SDK instalado y configurado
- [x] Server-side tracking en APIs cr√≠ticas
- [x] Client-side tracking con React hooks
- [x] Automatic page view tracking
- [x] Error tracking global
- [x] Onboarding flow tracking completo
- [x] Chat y AI agent usage tracking
- [x] User identification autom√°tica
- [x] TypeScript types para todos los eventos
- [x] Build exitoso sin errores cr√≠ticos

### üîÑ Pr√≥ximos Pasos Recomendados
- [ ] Configurar Segment Destinations (Facebook, Google, Email tools)
- [ ] Crear dashboards en Segment para monitoring
- [ ] Implementar A/B testing con Segment flags
- [ ] Agregar custom traits para user segmentation
- [ ] Configurar real-time triggers para marketing automation
- [ ] Implementar cohort analysis con retention tracking

---

## üìû **SOPORTE Y MANTENIMIENTO**

### Debugging Events
```javascript
// Client-side debug
localStorage.setItem('debug', 'segment:*');

// Server-side logs
console.log('[SEGMENT] Event tracked:', event, properties);
```

### Health Monitoring
- All events incluyen `timestamp` autom√°tico
- Server errors no rompen main request flow (try/catch)
- Client errors se reportan autom√°ticamente
- Performance tracking incluido por defecto

### Privacy Compliance
- Phone numbers se enmascaran autom√°ticamente
- User IDs son internos (no datos personales)
- Email tracking es opt-in via user consent
- GDPR compatible con user identification control

---

**üéâ IMPLEMENTACI√ìN COMPLETA - SISTEMA PRODUCTION-READY**

Fini AI ahora tiene tracking completo de analytics que permite:
- Marketing attribution detallado
- Upselling inteligente basado en usage
- Churn prevention proactivo  
- Feature adoption optimization
- Revenue attribution preciso
- Customer journey mapping completo

El sistema est√° optimizado para no afectar performance y es completamente compatible con la funcionalidad existente de la aplicaci√≥n.
